<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EzMate | Roommates (Minimal List + Interactions)</title>
  <style>
    :root{
      --primary:#2563EB; --secondary:#10B981; --bg:#F7F9FC; --card:#FFFFFF;
      --text:#0f172a; --muted:#475569; --border:#e5e7eb; --soft:#f3f4f6;
      --warn:#FEF3C7; --warnBorder:#F59E0B; --warnText:#92400E;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:20px 16px}
    a{text-decoration:none;color:inherit}

    /* Header */
    .top{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .brand{font-weight:800;color:var(--primary);font-size:1.15rem}
    .back{margin-left:auto;border:1px solid var(--primary);color:var(--primary);padding:.45rem .75rem;border-radius:10px;font-weight:600}
    .back:hover{background:var(--primary);color:#fff}

    /* Title/Search */
    .hero{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px 16px}
    .hero h1{margin:0 0 6px;font-size:1.35rem;letter-spacing:-.01em}
    .hero p{margin:0;color:var(--muted);font-size:.95rem}
    .tools{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .input{flex:1;min-width:210px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.6rem .75rem;color:#0f172a;outline:none}
    .input:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    .chip{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:.35rem .7rem;
      font-size:.85rem;color:#334155;cursor:pointer;transition:transform .15s, box-shadow .15s, background .15s, border-color .15s;
      user-select:none;
    }
    .chip.active{border-color:#c7d2fe;background:#eef2ff;color:#1d4ed8}
    .chip:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(37,99,235,.12);border-color:#bfd0ff;background:#f7faff}

    /* List */
    .list{margin:16px 0 28px;display:flex;flex-direction:column;gap:14px}
    .card{
      display:grid;grid-template-columns:56px 1fr;gap:14px;align-items:start;
      background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px;
      transition:box-shadow .2s, transform .2s;
    }
    .card:hover{box-shadow:0 10px 24px rgba(0,0,0,.06);transform:translateY(-1px)}
    .avatar{
      width:56px;height:56px;border-radius:50%;display:grid;place-items:center;
      color:#fff;font-weight:800;letter-spacing:.02em
    }
    .head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .name{font-weight:700;margin:0}
    .meta{margin:0;color:var(--muted);font-size:.9rem}
    .match{margin-left:auto;background:#e8faf3;border:1px solid #c7f0e2;color:#065f46;padding:.15rem .55rem;border-radius:999px;font-weight:700;font-size:.8rem}
    .bio{margin:.5rem 0;color:#334155}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:var(--soft);border:1px solid var(--border);padding:.25rem .55rem;border-radius:999px;font-size:.8rem;color:#334155}
    .actions{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
    .btn{flex:0 0 auto;border:1px solid var(--border);background:#fff;padding:.55rem .8rem;border-radius:10px;font-weight:700;cursor:pointer;transition:filter .15s,border-color .15s}
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{filter:brightness(.95)}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:14px;border:1px solid var(--border);max-width:560px;width:92%;padding:16px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .modal-title{font-weight:800;margin:0;font-size:1.05rem}
    .modal-close{border:none;background:transparent;font-size:1.2rem;cursor:pointer;padding:.25rem .4rem;border-radius:8px}
    .modal-close:hover{background:#f3f4f6}
    .modal-body{color:#334155;font-size:.95rem}

    /* Notice */
    .notice{background:var(--warn);border:1px solid var(--warnBorder);color:var(--warnText);padding:.7rem .9rem;border-radius:12px;margin:12px 0 0;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="index.html">EzMate</a>
      <a class="back" href="index.html">&larr; Back</a>
    </div>

    <section class="hero" aria-label="Search and filters">
      <h1>Compatible Roommates</h1>
      <p>Simple, focused list of people likely to vibe with you.</p>
      <div class="tools">
        <input id="search" class="input" type="search" placeholder="Search by name, role, tags, or habits…"/>
        <span class="chip active">High Match</span>
        <span class="chip">Quiet</span>
        <span class="chip">Clean</span>
        <span class="chip">Budget</span>
        <span class="chip">WFH</span>
      </div>
      <div id="net-notice" class="notice" style="display:none">Network issue — showing nothing from cache to avoid stale data. Retry later.</div>
    </section>

    <section class="list" id="list" aria-live="polite">
      <!-- cards injected -->
    </section>

    <div class="foot">&copy; 2025 EzMate, Inc. All rights reserved.</div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modal-title" class="modal-title">Profile</h3>
        <button class="modal-close" id="modal-close" aria-label="Close">&times;</button>
      </div>
      <div id="modal-body" class="modal-body"><!-- injected --></div>
    </div>
  </div>
    <!-- Remote data layer (Google Sheets ONLY, no proxy) -->
  <script>
    // ======= REQUIRED: your Sheet must be viewable by anyone (or Published to web) =======
    // Spreadsheet ID from the URL:
    // https://docs.google.com/spreadsheets/d/1ONVMDp_ljGsupJVrlVZ4-ueSafWCrxKQHhwruiJHrxM/edit
    const SPREADSHEET_ID = '1ONVMDp_ljGsupJVrlVZ4-ueSafWCrxKQHhwruiJHrxM';
    const USERS_SHEET_NAME = 'users';

    // Robust GVIZ URLs
    const GVIZ_JSON_URL =
      `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(USERS_SHEET_NAME)}`;
    const GVIZ_CSV_URL =
      `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(USERS_SHEET_NAME)}`;

    // Parse the weird GVIZ JSON (it wraps the JSON in setResponse(...))
    function parseGvizJson(text){
      const m = text.match(/setResponse\(([\s\S]*?)\);\s*$/);
      const jsonStr = m ? m[1] : text.substring(text.indexOf('{'), text.lastIndexOf(')'));
      return JSON.parse(jsonStr);
    }

    function normalizeRowObject(obj){
      // Normalize possible header-case differences and CSV habits
      const get = (k) => obj[k] ?? obj[k[0].toUpperCase() + k.slice(1)] ?? '';
      const habitsVal = get('habits');
      const habits = Array.isArray(habitsVal)
        ? habitsVal
        : (typeof habitsVal === 'string'
            ? habitsVal.split(',').map(s=>s.trim()).filter(Boolean)
            : []);
      return {
        email: String(get('email')).trim(),
        username: String(get('username')).trim(),
        phone: String(get('phone')).trim(),
        salt: String(get('salt')),
        hash: String(get('hash')),
        createdAt: String(get('createdAt') || get('created_at')),
        bio: String(get('bio')),
        habits
      };
    }

    async function apiGetUsersViaGvizJson(){
      const res = await fetch(GVIZ_JSON_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`GVIZ JSON HTTP ${res.status}`);
      const text = await res.text();

      const json = parseGvizJson(text);
      const cols = (json.table?.cols || []).map(c => (c.label || '').trim());
      const rows = (json.table?.rows || []).map(r => {
        const o = {};
        (r.c || []).forEach((cell, i) => {
          const key = cols[i] || '';
          if (!key) return;
          o[key] = cell ? cell.v : '';
        });
        return o;
      });
      return rows.map(normalizeRowObject);
    }

    async function apiGetUsersViaCsvFallback(){
      const res = await fetch(GVIZ_CSV_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error(`GVIZ CSV HTTP ${res.status}`);
      const text = await res.text();

      // very small CSV parser (handles simple cases)
      const lines = text.trim().split(/\r?\n/);
      if (!lines.length) return [];
      const headers = lines[0].split(',').map(h => h.trim());
      const out = [];
      for (let i = 1; i < lines.length; i++){
        const vals = lines[i].split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((h, idx) => obj[h] = vals[idx] ?? '');
        out.push(normalizeRowObject(obj));
      }
      return out;
    }

    // Single function the rest of the page uses.
    // Tries GVIZ JSON first, then CSV as a fallback.
    async function apiGetUsers(){
      try {
        const users = await apiGetUsersViaGvizJson();
        if (Array.isArray(users)) return users;
        throw new Error('GVIZ JSON returned non-array');
      } catch (e) {
        console.warn('GVIZ JSON failed, trying CSV fallback:', e);
        return await apiGetUsersViaCsvFallback();
      }
    }
  </script>

  <script>
    const USERS_KEY = 'ezmate_users';         // still used for phone lookup fallback
    const SESSION_KEY = 'ezmate_current_user';

    function saveUsers(users){ localStorage.setItem(USERS_KEY, JSON.stringify(users||[])); }
    function getSession(){ try { return JSON.parse(sessionStorage.getItem(SESSION_KEY)||'null') } catch { return null } }

    // Normalize habits (array or CSV)
    function normHabits(h){
      if (Array.isArray(h)) return h.filter(Boolean).map(String);
      if (typeof h === 'string') return h.split(',').map(s=>s.trim()).filter(Boolean);
      return [];
    }

    // Basic Jaccard similarity on habits (0..1)
    function habitsSimilarity(a = [], b = []) {
      const A = new Set((a||[]).map(x=>x.toLowerCase()));
      const B = new Set((b||[]).map(x=>x.toLowerCase()));
      if (!A.size && !B.size) return 0;
      let inter = 0; A.forEach(x=>{ if (B.has(x)) inter++; });
      const union = new Set([...A, ...B]).size || 1;
      return inter / union;
    }

    function initialFromName(name='?'){
      const t = (name.trim().split(/\s+/)[0]||'?').charAt(0).toUpperCase();
      return t || '?';
    }

    function cardHtml(user, scorePct){
      const tags = normHabits(user.habits).slice(0,3);
      const role = (user.role) || (user.email?.includes('student') ? 'Verified Student' : 'Verified User');
      const bio  = (user.bio) || 'No bio yet. This user recently joined EzMate.';
      const avatarColor = ['#2563EB','#10B981','#4F46E5','#1D4ED8','#0EA5E9','#EA580C','#7C3AED','#0F766E'][Math.floor(Math.random()*8)];
      return `
      <article class="card"
               data-name="${user.username||'-'}"
               data-role="${role}"
               data-tags="${normHabits(user.habits).join(' ').toLowerCase()}"
               data-bio="${bio}"
               data-profile="${bio}"
               data-email="${user.email||''}"
               data-phone="${user.phone||''}">
        <div class="avatar" style="background:${avatarColor}">${initialFromName(user.username||user.email||'?')}</div>
        <div>
          <div class="head">
            <div>
              <h3 class="name">${user.username || user.email}</h3>
              <p class="meta">${role}</p>
            </div>
            <span class="match">${scorePct}% Match</span>
          </div>
          <p class="bio">${bio}</p>
          <div class="tags">
            ${tags.map(t=>`<span class="tag">${t}</span>`).join('')}
          </div>
          <div class="actions">
            <button class="btn primary js-connect">Connect</button>
            <button class="btn js-view">View Profile</button>
          </div>
        </div>
      </article>`;
    }

    // De-dupe helper: keep newest by createdAt for each email
    function dedupeByEmail(rows){
      const map = new Map();
      for(const r of rows){
        const email = (r.email||'').toLowerCase();
        if(!email) continue;
        const prev = map.get(email);
        const currTs = Date.parse(r.createdAt||r.CreatedAt||r.created_at||'') || 0;
        const prevTs = prev ? (Date.parse(prev.createdAt||prev.CreatedAt||prev.created_at||'') || 0) : -1;
        if(!prev || currTs >= prevTs) map.set(email, r);
      }
      return Array.from(map.values());
    }

    // ---------- UPDATED: cache-aware renderList ----------
    async function renderList(){
      const list = document.getElementById('list');
      const notice = document.getElementById('net-notice');
      const session = getSession();
      const meEmail = (session?.email || '').toLowerCase();

      const getCache = () => {
        try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
        catch { return []; }
      };

      let users = [];
      let usedCache = false;

      // 1) Try live (Google Sheets via gviz in this file)
      try {
        users = await apiGetUsers();
        users = Array.isArray(users) ? users : [];
      } catch (e) {
        console.warn('[EzMate] live fetch failed:', e);
        users = [];
      }

      // 2) If live failed or returned nothing, fall back to cache
      if (!users.length) {
        const cached = getCache();
        if (cached.length) {
          users = cached;
          usedCache = true;
          console.info('[EzMate] using cached users:', users.length);
        }
      }

      // 3) Still nothing? Show friendly message and stop
      if (!users.length) {
        notice.style.display = 'block';
        notice.textContent = 'Network issue — no cached data yet. Try again later.';
        list.innerHTML = `<div style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;color:#334155">
          Unable to reach EzMate cloud right now. No cached users available.
        </div>`;
        return;
      }

      // 4) De-dupe + persist fresh cache (even if it came from cache)
      users = dedupeByEmail(users);
      saveUsers(users);

      // 5) Notice handling
      if (usedCache) {
        notice.style.display = 'block';
        notice.textContent = 'Network issue — showing cached data.';
      } else {
        notice.style.display = 'none';
      }

      // 6) Compute "me" habits (prefer session, else from row)
      const meRemote = users.find(u => (u.email || '').toLowerCase() === meEmail) || {};
      const meHabits = normHabits((session?.habits && session.habits.length) ? session.habits : meRemote.habits);

      // 7) Exclude myself
      const others = users.filter(u => (u.email || '').toLowerCase() !== meEmail);

      if (!others.length) {
        list.innerHTML = `<div style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;color:#334155">
          No other users yet. Share EzMate with friends and come back!
        </div>`;
        return;
      }

      // 8) Compatibility + render
      const enriched = others.map(u => {
        const sim = habitsSimilarity(meHabits, normHabits(u.habits));
        const pct = Math.max(60, Math.round(sim * 100)); // friendly floor
        return { user: u, pct };
      }).sort((a, b) => b.pct - a.pct);

      list.innerHTML = enriched.map(x => cardHtml(x.user, x.pct)).join('');
    }
    // ---------- /UPDATED renderList ----------

    // Search
    function normalize(s){ return (s||'').toLowerCase(); }
    function getSearchText(card){
      return [
        card.dataset.name,
        card.dataset.role,
        card.dataset.tags,
        card.dataset.bio
      ].map(normalize).join(' ');
    }
    function wireSearch(){
      const searchEl = document.getElementById('search');
      const list = document.getElementById('list');
      let cache = null;
      function snapshot(){
        const cards = Array.from(document.querySelectorAll('.card'));
        cache = new Map(cards.map(c => [c, getSearchText(c)]));
      }
      function applySearch(q){
        const needle = normalize(q).trim();
        const cards = Array.from(document.querySelectorAll('.card'));
        let visible = 0;
        cards.forEach(card => {
          const hay = cache.get(card);
          const show = !needle || hay.includes(needle);
          card.style.display = show ? 'grid' : 'none';
          if (show) visible++;
        });
        list.setAttribute('data-count', visible);
      }
      searchEl.addEventListener('input', (e)=>applySearch(e.target.value));
      // first snapshot after render
      setTimeout(()=>{ snapshot(); applySearch(''); }, 0);
    }

    // Modal (View Profile)
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody  = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');

    function openModal(title, body){
      modalTitle.textContent = title;
      modalBody.textContent = body;
      modal.classList.add('show');
      modalClose.focus();
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    // Only keep the view-profile handler (removed old hardcoded tel handler)
    document.addEventListener('click', (e)=>{
      const view = e.target.closest('.js-view');
      if (view) {
        const card = view.closest('.card');
        const title = card.dataset.name + ' — ' + card.dataset.role;
        const body  = card.dataset.profile || card.dataset.bio || '';
        openModal(title, body);
      }
    });

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });

    // Init
    (async function(){ await renderList(); wireSearch(); })();
  </script>

  <!-- Connect button → call the profile owner's phone -->
  <script>
    (function(){
      const USERS_KEY = 'ezmate_users';
      function loadUsers(){
        try { return JSON.parse(localStorage.getItem(USERS_KEY)) || []; }
        catch { return []; }
      }
      function normalizePhone(v){ return (v||'').replace(/\D/g,'').slice(-10); }

      // Capture phase so nothing else hijacks it
      document.addEventListener('click', function(e){
        const btn = e.target.closest('.js-connect');
        if(!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const card  = btn.closest('.card');
        const users = loadUsers();

        // 1) Prefer data-phone on the card
        let tel = card?.dataset?.phone;

        // 2) Try data-email match
        if(!tel && card?.dataset?.email){
          const u = users.find(x => (x.email || '').toLowerCase() === card.dataset.email.toLowerCase());
          if(u) tel = u.phone;
        }

        // 3) Fallback by name or email local-part
        if(!tel && card?.dataset?.name){
          const nm = card.dataset.name.trim().toLowerCase();
          const u = users.find(x => {
            const uname = (x.username || '').trim().toLowerCase();
            const mailPart = (x.email || '').split('@')[0].trim().toLowerCase();
            return uname === nm || mailPart === nm;
          });
          if(u) tel = u.phone;
        }

        const digits = normalizePhone(tel);
        if(digits.length === 10){
          window.location.href = `tel:+91${digits}`;
        } else {
          alert('Phone number for this profile is missing. Ask the user to add it in their profile.');
        }
      }, true);
    })();
  </script>



</body>
</html>

