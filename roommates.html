<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EzMate | Roommates (Minimal List + Interactions)</title>
  <style>
    :root{
      --primary:#2563EB; --secondary:#10B981; --bg:#F7F9FC; --card:#FFFFFF;
      --text:#0f172a; --muted:#475569; --border:#e5e7eb; --soft:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:20px 16px}
    a{text-decoration:none;color:inherit}

    /* Header */
    .top{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .brand{font-weight:800;color:var(--primary);font-size:1.15rem}
    .back{margin-left:auto;border:1px solid var(--primary);color:var(--primary);padding:.45rem .75rem;border-radius:10px;font-weight:600}
    .back:hover{background:var(--primary);color:#fff}

    /* Title/Search */
    .hero{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px 16px}
    .hero h1{margin:0 0 6px;font-size:1.35rem;letter-spacing:-.01em}
    .hero p{margin:0;color:var(--muted);font-size:.95rem}
    .tools{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .input{flex:1;min-width:210px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:.6rem .75rem;color:#0f172a;outline:none}
    .input:focus{border-color:#c7d2fe;box-shadow:0 0 0 4px rgba(99,102,241,.12)}
    .chip{
      border:1px solid var(--border);background:#fff;border-radius:999px;padding:.35rem .7rem;
      font-size:.85rem;color:#334155;cursor:pointer;transition:transform .15s, box-shadow .15s, background .15s, border-color .15s;
      user-select:none;
    }
    .chip.active{border-color:#c7d2fe;background:#eef2ff;color:#1d4ed8}
    .chip:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(37,99,235,.12);border-color:#bfd0ff;background:#f7faff}

    /* List */
    .list{margin:16px 0 28px;display:flex;flex-direction:column;gap:14px}
    .card{
      display:grid;grid-template-columns:56px 1fr;gap:14px;align-items:start;
      background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 14px;
      transition:box-shadow .2s, transform .2s;
    }
    .card:hover{box-shadow:0 10px 24px rgba(0,0,0,.06);transform:translateY(-1px)}
    .avatar{
      width:56px;height:56px;border-radius:50%;display:grid;place-items:center;
      color:#fff;font-weight:800;letter-spacing:.02em
    }
    .head{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .name{font-weight:700;margin:0}
    .meta{margin:0;color:var(--muted);font-size:.9rem}
    .match{margin-left:auto;background:#e8faf3;border:1px solid #c7f0e2;color:#065f46;padding:.15rem .55rem;border-radius:999px;font-weight:700;font-size:.8rem}
    .bio{margin:.5rem 0;color:#334155}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{background:var(--soft);border:1px solid var(--border);padding:.25rem .55rem;border-radius:999px;font-size:.8rem;color:#334155}
    .actions{display:flex;gap:8px;margin-top:10px;align-items:center;flex-wrap:wrap}
    .btn{flex:0 0 auto;border:1px solid var(--border);background:#fff;padding:.55rem .8rem;border-radius:10px;font-weight:700;cursor:pointer;transition:filter .15s,border-color .15s}
    .btn:hover{border-color:#cbd5e1}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{filter:brightness(.95)}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:50}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:14px;border:1px solid var(--border);max-width:560px;width:92%;padding:16px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .modal-title{font-weight:800;margin:0;font-size:1.05rem}
    .modal-close{border:none;background:transparent;font-size:1.2rem;cursor:pointer;padding:.25rem .4rem;border-radius:8px}
    .modal-close:hover{background:#f3f4f6}
    .modal-body{color:#334155;font-size:.95rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="index.html">EzMate</a>
      <a class="back" href="index.html">&larr; Back</a>
    </div>

    <section class="hero" aria-label="Search and filters">
      <h1>Compatible Roommates</h1>
      <p>Simple, focused list of people likely to vibe with you.</p>
      <div class="tools">
        <input id="search" class="input" type="search" placeholder="Search by name, role, tags, or habits…"/>
        <span class="chip active">High Match</span>
        <span class="chip">Quiet</span>
        <span class="chip">Clean</span>
        <span class="chip">Budget</span>
        <span class="chip">WFH</span>
      </div>
    </section>

    <section class="list" id="list" aria-live="polite">
      <!-- cards injected -->
    </section>

    <div class="foot">&copy; 2025 EzMate, Inc. All rights reserved.</div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="modal-title" class="modal-title">Profile</h3>
        <button class="modal-close" id="modal-close" aria-label="Close">&times;</button>
      </div>
      <div id="modal-body" class="modal-body"><!-- injected --></div>
    </div>
  </div>

  <script>
    const API_URL = '/api/sheet';            /* cloud proxy (Option 2) */
    const USERS_KEY = 'ezmate_users';        /* local fallback only */
    const SESSION_KEY = 'ezmate_current_user';

    /* session helpers */
    function getSession(){ try { return JSON.parse(sessionStorage.getItem(SESSION_KEY)||'null') } catch { return null } }

    /* normalize habits (array or CSV) */
    function getHabits(u){
      if(!u) return [];
      if(Array.isArray(u.habits)) return u.habits.filter(Boolean).map(String);
      if(typeof u.habits === 'string') return u.habits.split(',').map(s=>s.trim()).filter(Boolean);
      if(u.preferences && Array.isArray(u.preferences.habits)) return u.preferences.habits.filter(Boolean).map(String);
      return [];
    }

    /* Basic Jaccard similarity on habits (0..1) */
    function habitsSimilarity(a = [], b = []) {
      const A = new Set((a||[]).map(x=>String(x).toLowerCase()));
      const B = new Set((b||[]).map(x=>String(x).toLowerCase()));
      if (!A.size && !B.size) return 0;
      let inter = 0;
      A.forEach(x=>{ if (B.has(x)) inter++; });
      const union = new Set([...A, ...B]).size || 1;
      return inter / union;
    }

    function initialFromName(name='?'){
      const t = (String(name).trim().split(/\s+/)[0]||'?').charAt(0).toUpperCase();
      return t || '?';
    }

    function cardHtml(user, scorePct){
      const tags = getHabits(user).slice(0,3);
      const role = (user.role) || (String(user.email||'').includes('student') ? 'Verified Student' : 'Verified User');
      const bio  = (user.bio) || 'No bio yet. This user recently joined EzMate.';
      const avatarColor = ['#2563EB','#10B981','#4F46E5','#1D4ED8','#0EA5E9','#EA580C','#7C3AED','#0F766E'][Math.floor(Math.random()*8)];
      const emailAttr = (user.email||'').replace(/"/g,'');
      const phoneAttr = (user.phone||'').replace(/"/g,'');

      return `
      <article class="card"
               data-name="${(user.username||user.email||'-').replace(/"/g,'&quot;')}"
               data-role="${role}"
               data-tags="${getHabits(user).join(' ').toLowerCase()}"
               data-bio="${bio.replace(/"/g,'&quot;')}"
               data-profile="${bio.replace(/"/g,'&quot;')}"
               data-email="${emailAttr}"
               ${phoneAttr ? `data-phone="${phoneAttr}"` : ''}>
        <div class="avatar" style="background:${avatarColor}">${initialFromName(user.username||user.email||'?')}</div>
        <div>
          <div class="head">
            <div>
              <h3 class="name">${user.username || user.email}</h3>
              <p class="meta">${role}</p>
            </div>
            <span class="match">${scorePct}% Match</span>
          </div>
          <p class="bio">${bio}</p>
          <div class="tags">
            ${tags.map(t=>`<span class="tag">${t}</span>`).join('')}
          </div>
          <div class="actions">
            <button class="btn primary js-connect">Connect</button>
            <button class="btn js-view">View Profile</button>
          </div>
        </div>
      </article>`;
    }

    /* --- data sources --- */
    async function loadCloudUsers(){
      try{
        const res = await fetch(API_URL, { method:'GET', headers:{'Accept':'application/json'} });
        if(!res.ok) throw new Error('net');
        const data = await res.json();
        // Accept either {rows:[...]} or [...] shape
        const rows = Array.isArray(data) ? data : (Array.isArray(data.rows) ? data.rows : []);
        // Normalize keys commonly used in your project
        return rows.map(r => ({
          email: r.email || r.Email || r.mail || '',
          username: r.username || r.name || r.Username || '',
          phone: r.phone || r.Phone || '',
          bio: r.bio || r.Bio || '',
          habits: r.habits || r.Habits || r.preferences?.habits || []
        })).filter(u => u.email);
      }catch{
        return null; // signal failure -> fallback
      }
    }
    function loadLocalUsers(){
      try { return JSON.parse(localStorage.getItem(USERS_KEY)) || []; } catch { return []; }
    }

    async function renderList(){
      const list = document.getElementById('list');
      const session = getSession();
      const meEmail = (session?.email||'').toLowerCase();
      const meHabits = getHabits(session) || (loadLocalUsers().find(u=>String(u.email||'').toLowerCase()===meEmail)?.habits || []);

      // Try cloud first
      let users = await loadCloudUsers();
      if(!users){
        users = loadLocalUsers();
      }

      // Others only
      const others = (users||[]).filter(u => (String(u.email||'').toLowerCase() !== meEmail));

      if (!others.length){
        list.innerHTML = `<div style="background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;color:#334155">
          No other users yet. Share EzMate with friends and come back!
        </div>`;
        return;
      }

      // Sort by compatibility desc using the same Jaccard logic
      const enriched = others.map(u => {
        const sim = habitsSimilarity(meHabits, getHabits(u));
        return { user: u, pct: Math.round(sim*100) };
      }).sort((a,b)=>b.pct - a.pct);

      list.innerHTML = enriched.map(x => cardHtml(x.user, x.pct)).join('');

      // After cards are in DOM, prepare search cache
      setTimeout(snapshotSearchCache, 0);
    }

    // Search
    function normalize(s){ return (s||'').toLowerCase(); }
    function getSearchText(card){
      return [
        card.dataset.name,
        card.dataset.role,
        card.dataset.tags,
        card.dataset.bio
      ].map(normalize).join(' ');
    }
    let __searchCache = null;
    function snapshotSearchCache(){
      const cards = Array.from(document.querySelectorAll('.card'));
      __searchCache = new Map(cards.map(c => [c, getSearchText(c)]));
    }
    function wireSearch(){
      const searchEl = document.getElementById('search');
      const list = document.getElementById('list');
      function applySearch(q){
        const needle = normalize(q).trim();
        const cards = Array.from(document.querySelectorAll('.card'));
        let visible = 0;
        cards.forEach(card => {
          const hay = __searchCache ? __searchCache.get(card) : getSearchText(card);
          const show = !needle || (hay && hay.includes(needle));
          card.style.display = show ? 'grid' : 'none';
          if (show) visible++;
        });
        list.setAttribute('data-count', visible);
      }
      searchEl.addEventListener('input', (e)=>applySearch(e.target.value));
      setTimeout(()=>{ applySearch(''); }, 100);
    }

    // Modal (View Profile)
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody  = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');

    function openModal(title, body){
      modalTitle.textContent = title;
      modalBody.textContent = body;
      modal.classList.add('show');
      modalClose.focus();
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }

    // Global click handlers for connect/view
    document.addEventListener('click', (e)=>{
      const connect = e.target.closest('.js-connect');
      if (connect) {
        // Prefer the profile owner's registered phone from data attributes
        e.preventDefault();
        e.stopPropagation();
        const card = connect.closest('.card');
        const raw = (card?.dataset?.phone || '').replace(/\D/g,'').slice(-10);
        if(raw && raw.length===10){
          window.location.href = `tel:+91${raw}`;
        }else{
          alert('Phone number for this profile is missing. Ask the user to add it in their profile.');
        }
        return;
      }
      const view = e.target.closest('.js-view');
      if (view) {
        const card = view.closest('.card');
        const title = (card.dataset.name || 'Profile') + ' — ' + (card.dataset.role || '');
        const body  = card.dataset.profile || card.dataset.bio || '';
        openModal(title, body);
      }
    });

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && modal.classList.contains('show')) closeModal(); });

    // Init
    (async function init(){
      await renderList();
      wireSearch();
    })();
  </script>
</body>
</html>
